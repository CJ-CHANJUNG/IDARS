# POSCO 증빙 문서 자동화 워크플로우

## 🎯 전체 프로세스

```
┌─────────────────────────────────────────────────────────┐
│  1단계: PDF Splitter                                     │
│  원본 PDF → 문서 유형별로 자동 분류 및 분리              │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│  2단계: Parser                                            │
│  개별 PDF → 필드 자동 추출 → JSON                        │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│  3단계: 검증 (선택)                                       │
│  Accuracy Checker → 정확도 측정 및 개선                  │
└─────────────────────────────────────────────────────────┘
```

---

## 📦 필요한 파일

```
프로젝트 폴더/
├─ pdf_splitter.py          ← 1단계: 문서 분류
├─ posco_parser.py          ← 2단계: 필드 추출
├─ accuracy_checker.py      ← 3단계: 정확도 측정 (선택)
│
├─ pdf_splitter.md          ← Splitter 가이드
├─ posco_parser.md          ← Parser 가이드
├─ accuracy_checker.md      ← Checker 가이드
└─ README.md                ← 프로젝트 개요
```

---

## 🚀 빠른 시작 (전체 워크플로우)

### 1단계: PDF 분류
```bash
# pdf_splitter.py 설정
INPUT_FOLDER = r"D:\원본문서"
OUTPUT_FOLDER = r"D:\분류완료"

# 실행
python pdf_splitter.py
```

**결과:**
```
분류완료/
├─ invoice/
│   ├─ 문서1_invoice_01.pdf
│   └─ 문서2_invoice_01.pdf
├─ bl/
│   ├─ 문서1_bl_01.pdf
│   └─ 문서2_bl_01.pdf
└─ packing_list/
    └─ 문서1_packing_list_01.pdf
```

### 2단계: 필드 추출
```bash
# posco_parser.py 설정
INPUT_FOLDER = r"D:\분류완료\invoice"  # ← Splitter 결과!

# 실행
python posco_parser.py
```

**결과:**
```
parsed_results/
├─ 문서1_invoice_01_parsed.json
└─ 문서2_invoice_01_parsed.json
```

### 3단계: 정확도 측정 (선택)
```bash
# test_data.json 생성 (정답 데이터)
# accuracy_checker.py 설정
GROUND_TRUTH_FILE = r"D:\test_data.json"

# 실행
python accuracy_checker.py
```

**결과:**
```
📊 정확도 리포트
전체 정확도: 75%
```

---

## 📋 상세 워크플로우

### 시나리오 A: 단순 추출 (1회성)

**목표**: PDF에서 데이터만 빠르게 추출

```bash
# 1. 분류
python pdf_splitter.py

# 2. Invoice 추출
# posco_parser.py 수정: INPUT_FOLDER = r"D:\분류완료\invoice"
python posco_parser.py

# 3. BL 추출
# posco_parser.py 수정: INPUT_FOLDER = r"D:\분류완료\bl"
python posco_parser.py

# 완료!
```

**소요 시간**: 10분  
**필요 파일**: `pdf_splitter.py`, `posco_parser.py`

---

### 시나리오 B: 정확도 개선 (반복 작업)

**목표**: 95% 정확도 달성

```bash
# === 1주차: 초기 설정 ===

# 1. 분류
python pdf_splitter.py

# 2. 파싱
python posco_parser.py

# 3. 정답 데이터 생성 (20-30개 샘플)
# test_data.json 수동 작성

# 4. 정확도 측정
python accuracy_checker.py
# → 결과: 68%

# === 2주차: 개선 작업 ===

# 5. 가장 틀리는 필드 확인
# TOP 3: bl_number, total_amount, invoice_number

# 6. 패턴 개선
# posco_parser.py의 Patterns 클래스 수정

# 7. 재측정
python accuracy_checker.py
# → 결과: 75%

# === 3주차: 반복 ===

# 8-10. 5-7 반복
# → 최종: 95% 달성!
```

**소요 시간**: 2-3주  
**필요 파일**: 전체

---

### 시나리오 C: 대량 처리 (월 10,000 페이지)

**목표**: 효율적인 대량 처리

```python
# batch_process.py 생성
import subprocess
from pathlib import Path

def batch_split():
    """모든 원본 PDF 분류"""
    print("1단계: PDF 분류 시작...")
    subprocess.run(["python", "pdf_splitter.py"])

def batch_parse():
    """모든 문서 유형별 파싱"""
    output_dir = Path(r"D:\분류완료")
    
    for doc_type in ['invoice', 'bl', 'packing_list']:
        folder = output_dir / doc_type
        if not folder.exists():
            continue
        
        print(f"2단계: {doc_type} 파싱 중...")
        
        # posco_parser.py의 INPUT_FOLDER를 동적으로 변경
        # 또는 여러 번 실행
        
def main():
    batch_split()
    batch_parse()
    print("완료!")

if __name__ == "__main__":
    main()
```

**소요 시간**: 1-2시간 (10,000 페이지 기준)

---

## 🎯 각 단계별 핵심 설정

### 1단계: pdf_splitter.py
```python
# 필수 설정
INPUT_FOLDER = r"D:\원본문서"
OUTPUT_FOLDER = r"D:\분류완료"

# 중요 설정
DOCUMENT_TYPES = {
    'invoice': True,       # ✅ 반드시
    'bl': True,            # ✅ 반드시
    'packing_list': True,  # ✅ 반드시
    'certificate': True,   # 선택
    'insurance': False,    # 불필요시
}
```

### 2단계: posco_parser.py
```python
# 필수 설정
INPUT_FOLDER = r"D:\분류완료\invoice"  # ← Splitter 결과!
OUTPUT_FOLDER = ""  # 비워두면 자동 생성

# 성능 설정
PARALLEL_WORKERS = 4  # 대량 처리시
VERBOSE = False       # 대량 처리시
```

### 3단계: accuracy_checker.py
```python
# 필수 설정
GROUND_TRUTH_FILE = r"D:\test_data.json"
PDF_FOLDER = ""  # 비워두면 자동
```

---

## 📊 폴더 구조 예시

### 권장 구조
```
D:\POSCO_IDARS\
├─ 00_원본문서/              ← 최초 업로드된 PDF
│   ├─ 거래1.pdf
│   ├─ 거래2.pdf
│   └─ 거래3.pdf
│
├─ 01_분류완료/              ← Splitter 결과
│   ├─ invoice/
│   │   ├─ 거래1_invoice_01.pdf
│   │   └─ 거래2_invoice_01.pdf
│   ├─ bl/
│   │   └─ 거래1_bl_01.pdf
│   └─ packing_list/
│       └─ 거래1_packing_list_01.pdf
│
├─ 02_파싱결과/              ← Parser 결과
│   ├─ invoice/
│   │   ├─ 거래1_invoice_01_parsed.json
│   │   └─ 거래2_invoice_01_parsed.json
│   ├─ bl/
│   │   └─ 거래1_bl_01_parsed.json
│   └─ packing_list/
│       └─ 거래1_packing_list_01_parsed.json
│
├─ 03_정답데이터/            ← Accuracy Checker용
│   ├─ test_data.json
│   └─ accuracy_report.json
│
└─ 프로그램/                 ← Python 파일들
    ├─ pdf_splitter.py
    ├─ posco_parser.py
    └─ accuracy_checker.py
```

---

## 🔄 반복 작업 자동화

### 매일 실행하는 경우

**Option 1: 배치 스크립트 (Windows)**
```batch
@echo off
REM run_daily.bat

cd D:\POSCO_IDARS\프로그램

echo ========================================
echo 1단계: PDF 분류
echo ========================================
python pdf_splitter.py

echo.
echo ========================================
echo 2단계: Invoice 파싱
echo ========================================
REM INPUT_FOLDER를 invoice로 변경 필요
python posco_parser.py

echo.
echo ========================================
echo 3단계: BL 파싱
echo ========================================
REM INPUT_FOLDER를 bl로 변경 필요
python posco_parser.py

echo.
echo 완료!
pause
```

**Option 2: Python 스크립트**
```python
# run_pipeline.py
import subprocess
import sys

def run_command(cmd, description):
    print(f"\n{'='*60}")
    print(f"{description}")
    print(f"{'='*60}")
    result = subprocess.run(cmd, shell=True)
    if result.returncode != 0:
        print(f"❌ 오류 발생!")
        sys.exit(1)

def main():
    # 1단계
    run_command(
        "python pdf_splitter.py",
        "1단계: PDF 분류"
    )
    
    # 2단계 - Invoice
    # INPUT_FOLDER를 동적으로 변경하거나
    # 각 유형별로 별도 실행
    
    print("\n✅ 모든 작업 완료!")

if __name__ == "__main__":
    main()
```

---

## 💡 실전 팁

### 1. Splitter 결과 검증
분류가 끝나면 랜덤으로 10개 정도 열어보세요:
```bash
# unknown 폴더 확인 (중요!)
cd D:\분류완료\unknown
dir

# 각 폴더에서 랜덤 샘플 확인
```

### 2. Parser 단계별 실행
한 번에 모든 유형을 파싱하지 말고:
```bash
# Invoice만 먼저
python posco_parser.py
# → 결과 확인

# 이상 없으면 BL
# INPUT_FOLDER 변경 후
python posco_parser.py
# → 결과 확인
```

### 3. 로그 저장
```bash
# 로그 파일로 저장
python pdf_splitter.py > log_splitter.txt 2>&1
python posco_parser.py > log_parser.txt 2>&1
```

### 4. 에러 복구
중간에 오류나면:
```bash
# 실패한 파일만 다시 처리
# OUTPUT_FOLDER에서 성공한 파일 제외
```

---

## 📈 성능 최적화

### 대량 처리 (1,000+ 페이지)
```python
# pdf_splitter.py
VERBOSE = False  # 출력 최소화

# posco_parser.py
PARALLEL_WORKERS = 4  # 병렬 처리
VERBOSE = False
```

### 품질 우선 (소량, 정확도 중요)
```python
# pdf_splitter.py
VERBOSE = True  # 상세 확인
MIN_PAGES = 2   # 페이지 수 체크

# posco_parser.py
PARALLEL_WORKERS = 1
VERBOSE = True
```

---

## 🐛 문제 해결

### Splitter 단계 오류
```
증상: 분류가 엉망
해결: 
1. unknown 폴더 확인
2. DOCUMENT_TYPES 확인
3. 키워드 추가 (pdf_splitter.md 참고)
```

### Parser 단계 오류
```
증상: 필드가 추출 안 됨
해결:
1. Splitter 결과가 올바른지 확인
2. 정규식 패턴 확인 (posco_parser.md 참고)
3. 샘플 PDF 직접 열어서 텍스트 확인
```

### 전체 파이프라인 오류
```
증상: 경로 오류
해결:
1. 폴더 구조 확인
2. 각 단계의 INPUT/OUTPUT 경로 확인
3. 상대 경로 대신 절대 경로 사용
```

---

## ✅ 최종 체크리스트

**초기 설정:**
- [ ] 폴더 구조 생성
- [ ] Python 및 PyMuPDF 설치
- [ ] 모든 .py 파일 준비

**1단계 (Splitter):**
- [ ] pdf_splitter.py 설정
- [ ] 실행 및 결과 확인
- [ ] unknown 폴더 확인

**2단계 (Parser):**
- [ ] posco_parser.py 설정
- [ ] Invoice 파싱
- [ ] BL 파싱
- [ ] Packing List 파싱
- [ ] 결과 JSON 확인

**3단계 (검증 - 선택):**
- [ ] test_data.json 생성
- [ ] accuracy_checker.py 실행
- [ ] 정확도 확인
- [ ] 필요시 개선

**자동화 (선택):**
- [ ] 배치 스크립트 작성
- [ ] 일일 작업 자동화
- [ ] 로그 시스템 구축

---

**단계별 정제로 완벽한 데이터를!** 🚀
